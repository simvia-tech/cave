name: Builds
on:
  push:
    branches: [main]
  workflow_call:
    inputs:
      artifact-name:
        description: Base name for uploaded artifacts
        required: true
        type: string
    outputs:
      deb-artifact:
        description: "Debian package artifact ID"
        value: ${{ jobs.build-binary-and-package.outputs.deb-artifact }}
      rpm-artifact:
        description: "RPM package artifact ID"
        value: ${{ jobs.build-binary-and-package.outputs.rpm-artifact }}
      bin-artifact:
        description: "Binary artifact ID"
        value: ${{ jobs.build-binary-and-package.outputs.bin-artifact }}
      man-artifact:
        description: "Man page artifact ID"
        value: ${{ jobs.build-binary-and-package.outputs.man-artifact }}

jobs:
  build-binary-and-package:
    runs-on: ubuntu-latest
    outputs:
      deb-artifact: ${{ steps.upload-deb.outputs.artifact-id }}
      rpm-artifact: ${{ steps.upload-rpm.outputs.artifact-id }}
      bin-artifact: ${{ steps.upload-bin.outputs.artifact-id }}
      man-artifact: ${{ steps.upload-man.outputs.artifact-id }}
    container:
      image: rust:bullseye
    steps:
      - name: Check out repository code
        uses: actions/checkout@v5

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo target
        uses: actions/cache@v4
        with:
          path: target/
          key: ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-

      - name: Install system dependencies
        run: apt-get update && apt-get install -y protobuf-compiler musl musl-dev musl-tools pkg-config

      - name: Install rustup depencencies
        run: rustup target add x86_64-unknown-linux-musl

      - name: Build release binary
        run: cargo build --release --target x86_64-unknown-linux-musl

      - name: Upload compiled binary
        uses: actions/upload-artifact@v4
        id: upload-bin
        with:
          name: ${{ inputs.artifact-name }}compiled-binary
          path: target/x86_64-unknown-linux-musl/release/cave

      - name: Upload man page
        uses: actions/upload-artifact@v4
        id: upload-man
        with:
          name: ${{ inputs.artifact-name }}man-page
          path: man/cave.1

      - name: Cache cargo tools
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/
          key: ${{ runner.os }}-cargo-tools-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-tools-

      - name: Install cargo packaging tools
        run: |
          if ! command -v cargo-deb &> /dev/null || ! command -v cargo-generate-rpm &> /dev/null; then
            cargo install cargo-deb cargo-generate-rpm
          fi

      - name: Build Debian package
        run: cargo deb --target x86_64-unknown-linux-musl
        continue-on-error: true   # optional

      - name: Build RPM package
        run: cargo generate-rpm --target x86_64-unknown-linux-musl
        continue-on-error: true   # optional

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        id: upload-deb
        with:
          name: ${{ inputs.artifact-name }}deb-package
          path: target/x86_64-unknown-linux-musl/debian/*

      - name: Upload RPM package
        uses: actions/upload-artifact@v4
        id: upload-rpm   
        with:
          name: ${{ inputs.artifact-name }}rpm-package
          path: target/x86_64-unknown-linux-musl/generate-rpm/*